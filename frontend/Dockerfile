FROM node:20-alpine as build

WORKDIR /app
ARG NEXT_PUBLIC_CHAT_API
ARG NEXT_PUBLIC_CHAT_API
ARG NEXT_PUBLIC_LANGFUSE_PUBLIC_KEY
ARG NEXT_PUBLIC_LANGFUSE_PRIVATE_KEY
ARG NEXT_PUBLIC_LANGFUSE_API_URL

# Install dependencies
COPY package.json package-lock.* ./
RUN npm install

# Build the application
COPY . .
RUN npm run build

# setting them to ENV if needed in the build
ENV NEXT_PUBLIC_CHAT_API=$NEXT_PUBLIC_CHAT_API
ENV NEXT_PUBLIC_LANGFUSE_PUBLIC_KEY=$NEXT_PUBLIC_LANGFUSE_PUBLIC_KEY
ENV NEXT_PUBLIC_LANGFUSE_PRIVATE_KEY=$NEXT_PUBLIC_LANGFUSE_PRIVATE_KEY
ENV NEXT_PUBLIC_LANGFUSE_API_URL=$NEXT_PUBLIC_LANGFUSE_API_URL

# ====================================
FROM build as release

CMD ["npx", "-y", "serve@latest", "out"]